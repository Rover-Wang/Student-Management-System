{% extends 'base.html' %}
{% block title %}è¯¾ç¨‹ç®¡ç† - å­¦ç”Ÿä¸­å¿ƒ{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card bg-primary text-white shadow-sm mb-4">
        <div class="card-body p-4 d-flex justify-content-between align-items-center">
            <div>
                <h5 class="opacity-75">å½“å‰å¹³å‡ç»©ç‚¹ (GPA)</h5>
                {% set stats = namespace(credits=0, points=0) %}
                {% for en in enrollments %}
                    {% if en.score is not none %}
                        {% set stats.credits = stats.credits + en.course.credit %}
                        {% set stats.points = stats.points + (en.grade_point * en.course.credit) %}
                    {% endif %}
                {% endfor %}
                {% set gpa = (stats.points / stats.credits) if stats.credits > 0 else 0 %}
                <h2 class="display-5 fw-bold mb-0">
                    {{ "%.2f"|format(gpa) if gpa > 0 else 'æš‚æ— æ•°æ®' }}
                </h2>
            </div>
            <i class="bi bi-award fs-1 opacity-50"></i>
        </div>
    </div>

    <div class="card shadow-sm mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>é€‰è¯¾å¤§å… (æ‰€æœ‰å¼€æ”¾è¯¾ç¨‹)</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('student.select_course') }}" method="POST">
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th>é€‰æ‹©</th>
                                <th>è¯¾ç¨‹åç§°</th>
                                <th>å­¦åˆ†</th>
                                <th>ä»»è¯¾è€å¸ˆ</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in all_courses %}
                            <tr>
                                <td>
                                    {% if course.id not in selected_course_ids %}
                                    <input type="checkbox" name="course_ids" value="{{ course.id }}">
                                    {% else %}
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    {% endif %}
                                </td>
                                <td>{{ course.name }}</td>
                                <td>{{ course.credit }}</td>
                                <td>{{ course.teacher.username if course.teacher else 'æœªçŸ¥' }}</td>
                                <td>
                                    {% if course.id in selected_course_ids %}
                                    <span class="badge bg-secondary">å·²åœ¨æ¸…å•ä¸­</span>
                                    {% else %}
                                    <span class="badge bg-outline-primary text-primary border border-primary">å¯é€‰</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn btn-primary btn-sm mt-2">ç¡®è®¤é€‰è¯¾</button>
            </form>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3 border-bottom">
            <h5 class="mb-0 text-dark"><i class="bi bi-journal-check me-2 text-primary"></i>å·²é€‰è¯¾ç¨‹æ˜ç»† & æˆç»©</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">è¯¾ç¨‹åç§°</th>
                        <th>å­¦åˆ†</th>
                        <th>æˆç»© (æ•™å¸ˆå½•å…¥)</th>
                        <th>ç»©ç‚¹</th>
                        <th class="text-end pe-4">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {# ğŸ’¡ å…³é”®ï¼šå¾ªç¯æ¸²æŸ“ enrollments å¯¹è±¡ #}
                    {% for en in enrollments %}
                    <tr>
                        <td class="ps-4"><strong>{{ en.course.name }}</strong></td>
                        <td>{{ en.course.credit }}</td>
                        <td>
                            {% if en.score is not none %}
                                <span class="badge {% if en.score >= 60 %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ en.score }} åˆ†
                                </span>
                            {% else %}
                                <span class="text-muted small italic">å¾…è€å¸ˆå½•å…¥</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="fw-bold {{ 'text-primary' if en.grade_point > 0 else 'text-muted' }}">
                                {{ "%.1f"|format(en.grade_point) if en.score is not none else '-' }}
                            </span>
                        </td>
                        <td class="text-end pe-4">
                            {# åé¦ˆé“¾æ¥ #}
                            <a href="{{ url_for('student.send_feedback_to_teacher', recipient_id=en.course.teacher_id, subject='å…³äºã€Š' ~ en.course.name ~ 'ã€‹çš„åé¦ˆ') }}" 
                               class="btn btn-sm btn-outline-info me-2">åé¦ˆ</a>
                            {# é€€è¯¾é“¾æ¥ #}
                            <a href="{{ url_for('student.drop_course', course_id=en.course_id) }}" 
                               class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šé€€è¯¾å—ï¼Ÿæˆç»©ä¹Ÿå°†è¢«åˆ é™¤')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            æš‚æ— å·²é€‰è¯¾ç¨‹ï¼Œè¯·åœ¨ä¸Šæ–¹â€œé€‰è¯¾å¤§å…â€è¿›è¡Œé€‰è¯¾ã€‚
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}